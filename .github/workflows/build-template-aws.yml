name: Build Template AWS (ECR)

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      project:
        required: true
        type: string
      aws-region:
        required: true
        type: string
      registry:
        required: true
        type: string
      dockerfile-path:
        required: false
        type: string
        default: "Dockerfile"
      context:
        required: false
        type: string
        default: "."
      version-prefix:
        required: false
        type: string
        default: "0.0"
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
    outputs:
      image:
        description: "Imagem gerada (tag versionada)"
        value: ${{ jobs.build.outputs.image }}

jobs:
  build:
    name: Build & Push (ECR)
    runs-on: ubuntu-latest

    outputs:
      image: ${{ steps.meta.outputs.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Dockerfile exists
        shell: bash
        run: |
          set -euo pipefail
          echo "Dockerfile path: '${{ inputs.dockerfile-path }}'"
          echo "Context: '${{ inputs.context }}'"
          if [ ! -f "${{ inputs.dockerfile-path }}" ]; then
            echo "::error::Dockerfile not found at '${{ inputs.dockerfile-path }}'. Create it or update dockerfile-path."
            echo "Repo tree (top 2 levels):"
            ls -la
            find . -maxdepth 2 -type f | sed 's|^\./||'
            exit 1
          fi

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws-region }}

      - name: Ensure ECR repo exists (env/project)
        id: repo
        shell: bash
        run: |
          set -euo pipefail
          ECR_REPO="${{ inputs.environment }}/${{ inputs.project }}"
          echo "ECR_REPO=$ECR_REPO" >> $GITHUB_ENV
          aws ecr describe-repositories --repository-names "$ECR_REPO" >/dev/null 2>&1 || \
            aws ecr create-repository --repository-name "$ECR_REPO" >/dev/null
          echo "Using ECR repository: $ECR_REPO"

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Define image tag (versioned)
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ inputs.version-prefix }}.${{ github.run_number }}"
          IMAGE="${{ inputs.registry }}/${ECR_REPO}:${VERSION}"
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "Image: $IMAGE"

      - name: Build & Push
        shell: bash
        run: |
          set -euo pipefail
          docker build \
            -t "${{ steps.meta.outputs.image }}" \
            -f "${{ inputs.dockerfile-path }}" \
            "${{ inputs.context }}"
          docker push "${{ steps.meta.outputs.image }}"
